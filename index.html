<!-- index.html ‚Äî Random Live Cams (PLAYER) v2.2.1+ (NEWSROOM/BROADCAST)
  ‚úÖ Compatible con:
    - styles.css (Neo-Atlas)
    - cams.js, music.js
    - weatherClock.js, newsTicker.js, catalogView.js, app.js
  ‚úÖ Countdown bootstrap:
    - Compatible con cfg desde control.js: { enabled, label, targetMs }
    - Compatible con legacy: { targetIso } y URL params antiguos/nuevos
-->
<!doctype html>
<html lang="es" data-theme="dark" data-ui="neo-atlas">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="format-detection" content="telephone=no" />

  <title>Random Live Cams</title>
  <meta name="description" content="Random Live Cams ‚Äî rotaci√≥n de c√°maras con HUD, votaci√≥n por Twitch, chat overlay, alerts y ads notice." />

  <link rel="stylesheet" href="./styles.css" />

  <!-- hls.js (solo si usas cams HLS .m3u8) -->
  <script defer src="https://cdn.jsdelivr.net/npm/hls.js@1.5.18/dist/hls.min.js"></script>

  <script>window.APP_VERSION = "2.2.1";</script>

  <!-- ‚úÖ Countdown styles m√≠nimos (el resto ya va en styles.css) -->
  <style>
    #rlcCountdown{
      position:absolute;
      z-index: 50;
      top: calc(12px + var(--ui-top-offset));
      right: 14px;

      display:flex;
      flex-direction:column;
      gap:6px;

      padding:10px 12px;
      border-radius:14px;

      background: linear-gradient(180deg, var(--news-bg-top), var(--news-bg-bot));
      border: 1px solid var(--stroke);

      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      box-shadow: 0 18px 55px rgba(0,0,0,.55);
      color: rgba(255,255,255,.94);
      max-width: min(340px, calc(100vw - 24px));
      overflow:hidden;
    }
    #rlcCountdown.hidden{ display:none; }
    #rlcCountdown .lbl{
      font: 950 12px/1 ui-sans-serif, system-ui;
      letter-spacing:.14em;
      opacity: .92;
      text-transform: uppercase;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      display:flex;
      align-items:center;
      gap:8px;
    }
    #rlcCountdown .lbl::before{
      content:"";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--news-red);
      box-shadow: 0 0 0 3px rgba(255,55,95,.18), 0 0 16px rgba(255,55,95,.45);
    }
    #rlcCountdown .time{
      font: 950 20px/1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.02em;
      font-variant-numeric: tabular-nums;
    }
    #rlcCountdown.tr{ top: calc(12px + var(--ui-top-offset)); right: 14px; left:auto; bottom:auto; }
    #rlcCountdown.tl{ top: calc(12px + var(--ui-top-offset)); left: 14px; right:auto; bottom:auto; }
    #rlcCountdown.br{ bottom: 14px; right: 14px; top:auto; left:auto; }
    #rlcCountdown.bl{ bottom: 14px; left: 14px; top:auto; right:auto; }
  </style>
</head>

<body class="mode-player">
  <main id="app" class="app" role="application" aria-label="Random Live Cams">
    <section id="stage" class="stage" aria-label="Reproductor de c√°mara">
      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Media Layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="layer layer-media" aria-hidden="true">
        <!-- YouTube -->
        <iframe
          id="frame"
          class="media hidden"
          title="Live Cam"
          referrerpolicy="strict-origin-when-cross-origin"
          allow="autoplay; encrypted-media; picture-in-picture"
          allowfullscreen
        ></iframe>

        <!-- HLS -->
        <video
          id="video"
          class="media hidden"
          autoplay
          muted
          playsinline
          webkit-playsinline
        ></video>

        <!-- Imagen -->
        <img id="img" class="media hidden" alt="Webcam snapshot" />
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Fallback Layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div id="fallback" class="fallback hidden" role="status" aria-live="polite">
        <div class="fallbackCard">
          <div class="fallbackTitle">No se puede mostrar esta c√°mara aqu√≠</div>
          <div class="fallbackText">
            Puede estar offline o bloquear el embed. Saltando‚Ä¶
          </div>
          <a id="fallbackLink" class="btn" href="#" target="_blank" rel="noopener">Ver en origen</a>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Overlay Layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
      <div class="layer layer-ui" aria-label="Overlays">
        <!-- HUD -->
        <div id="hud" class="hud hud--collapsed" aria-label="HUD stream">
          <div class="hudBar">
            <div class="hudLeft" id="hudLeft">
              <div class="badge" id="badgeLive">LIVE</div>

              <!-- ‚úÖ Title ticker listo: data-title + data-marquee -->
              <div class="hudTitle" id="hudTitle" data-title="Cargando‚Ä¶" data-marquee="0">Cargando‚Ä¶</div>

              <!-- ‚úÖ WX fijo (styles.css lo deja perfecto) -->
              <div id="rlcHudWx" class="wxOff" aria-live="polite">
                <span id="rlcHudWxIcon" aria-hidden="true">üå°Ô∏è</span>
                <span id="rlcHudWxTemp" class="wxTemp">‚Äî¬∞C</span>
                <span class="wxDot" aria-hidden="true">¬∑</span>
                <span id="rlcHudWxTime" class="wxTime">--:--</span>
              </div>
            </div>

            <div class="hudRight">
              <div class="hudCountdown mono" id="hudCountdown">05:00</div>
              <button
                id="hudToggle"
                class="hudToggle"
                type="button"
                aria-label="Expandir HUD"
                aria-expanded="false"
              >‚ñ∏</button>
            </div>
          </div>

          <div class="progress" aria-hidden="true">
            <div id="progressBar" class="progressBar"></div>
          </div>

          <div id="hudDetails" class="hudDetails">
            <div class="hudRow">
              <div class="hudLabel">Lugar</div>
              <div class="hudValue" id="hudPlace">‚Äî</div>
            </div>

            <div class="hudRow">
              <div class="hudLabel">Fuente</div>
              <div class="hudValue">
                <span id="hudSource">‚Äî</span>
                <span class="dot">‚Ä¢</span>
                <a id="hudOrigin" class="hudLink" href="#" target="_blank" rel="noopener">Origen</a>
              </div>
            </div>

            <div class="hudFooter">
              <span id="hudIndex">‚Äî</span>
              <span class="dot">‚Ä¢</span>
              <span class="muted">
                Espacio pausa ¬∑ N siguiente ¬∑ P anterior ¬∑ H HUD ¬∑ I detalles ¬∑ C chat
              </span>
            </div>
          </div>
        </div>

        <!-- ‚úÖ COUNTDOWN overlay -->
        <div id="rlcCountdown" class="hidden tr" aria-live="polite">
          <div class="lbl" id="rlcCountdownLabel">FIN DE A√ëO</div>
          <div class="time mono" id="rlcCountdownTime">--:--:--</div>
        </div>

        <!-- VOTE overlay -->
        <div id="voteBox" class="vote hidden" aria-label="Votaci√≥n del chat" aria-live="polite">
          <div class="voteTop">
            <div class="voteTitle">VOTA</div>
            <div class="voteTime mono" id="voteTime">00:20</div>
          </div>

          <div class="voteHint" id="voteHint">Votaci√≥n en‚Ä¶</div>

          <div class="voteBars" aria-hidden="false">
            <div class="voteBar">
              <div class="voteBarFill" id="voteYes"></div>
              <div class="voteBarLabel">
                <span>NEXT</span>
                <span id="voteYesN">0</span>
              </div>
            </div>

            <div class="voteBar">
              <div class="voteBarFill no" id="voteNo"></div>
              <div class="voteBarLabel">
                <span>STAY</span>
                <span id="voteNoN">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat overlay -->
        <div id="rlcChatRoot" class="rlcChatRoot" aria-label="Chat overlay" aria-live="polite">
          <div id="rlcChatList"></div>
        </div>
      </div>

      <!-- Audio BGM -->
      <audio id="bgm" preload="auto" crossorigin="anonymous"></audio>
    </section>
  </main>

  <!-- Base data -->
  <script defer src="./cams.js"></script>
  <script defer src="./music.js"></script>

  <!-- ‚úÖ Weather + hora local por cam -->
  <script defer src="./weatherClock.js"></script>

  <!-- ‚úÖ Ticker de noticias -->
  <script defer src="./newsTicker.js"></script>

  <!-- ‚úÖ Cat√°logo CCTV -->
  <script defer src="./catalogView.js"></script>

  <!-- Main player logic -->
  <script defer src="./app.js"></script>

  <!-- ‚úÖ Countdown bootstrap (BC + localStorage + URL params) + hide HUD when catalog ON -->
  <script>
    (() => {
      "use strict";

      const g = (typeof globalThis !== "undefined") ? globalThis : window;
      const LOAD_GUARD = "__RLC_COUNTDOWN_BOOT_V110";
      try { if (g[LOAD_GUARD]) return; g[LOAD_GUARD] = true; } catch (_) {}

      const BUS_BASE = "rlc_bus_v1";
      const CD_KEY_BASE = "rlc_countdown_cfg_v1";

      const qs = (s, r=document) => r.querySelector(s);
      const safeStr = (v) => (typeof v === "string") ? v.trim() : "";

      function parseParams() {
        const u = new URL(location.href);

        // ‚úÖ acepta params antiguos y nuevos
        const countdown = safeStr(u.searchParams.get("countdown") || "");
        const key = safeStr(u.searchParams.get("key") || "");

        const toA = safeStr(u.searchParams.get("countdownTo") || "");
        const toB = safeStr(u.searchParams.get("countTo") || "");
        const labelA = safeStr(u.searchParams.get("countdownLabel") || "");
        const labelB = safeStr(u.searchParams.get("countLabel") || "");
        const posA = safeStr(u.searchParams.get("countdownPos") || "");
        const posB = safeStr(u.searchParams.get("countPos") || "");

        return {
          key,
          countdown,
          countdownTo: toA || toB,
          countdownLabel: labelA || labelB,
          countdownPos: posA || posB
        };
      }

      const P = parseParams();
      const KEY = P.key;

      const BUS = KEY ? `${BUS_BASE}:${KEY}` : BUS_BASE;
      const BUS_LEGACY = BUS_BASE;

      const CD_KEY = KEY ? `${CD_KEY_BASE}:${KEY}` : CD_KEY_BASE;
      const CD_KEY_LEGACY = CD_KEY_BASE;

      const bcMain = ("BroadcastChannel" in window) ? new BroadcastChannel(BUS) : null;
      const bcLegacy = (("BroadcastChannel" in window) && KEY) ? new BroadcastChannel(BUS_LEGACY) : null;

      function keyOk(msg, isMainChannel) {
        if (!KEY) return true;
        if (isMainChannel) return true;
        return (msg && msg.key === KEY);
      }

      const DEFAULTS = {
        enabled: false,
        label: "FIN DE A√ëO",
        targetMs: 0,          // ‚úÖ forma nueva (control.js)
        targetIso: "",        // ‚úÖ legacy
        position: "tr",
        hideHudWhenCatalog: true
      };

      function readJson(key) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          return (obj && typeof obj === "object") ? obj : null;
        } catch (_) { return null; }
      }

      function normalizeCfg(inCfg) {
        const c = Object.assign({}, DEFAULTS, inCfg || {});
        c.enabled = (c.enabled === true);

        c.label = safeStr(c.label || DEFAULTS.label).slice(0, 60) || DEFAULTS.label;

        // position
        c.position = (c.position === "tl" || c.position === "tr" || c.position === "bl" || c.position === "br")
          ? c.position : "tr";

        c.hideHudWhenCatalog = (c.hideHudWhenCatalog !== false);

        // targetMs (prefer)
        const ms = (typeof c.targetMs === "number") ? c.targetMs : parseInt(String(c.targetMs || "0"), 10);
        c.targetMs = Number.isFinite(ms) ? Math.max(0, ms) : 0;

        // legacy iso
        c.targetIso = safeStr(c.targetIso || "");

        // si viene URL como epoch
        if (!c.targetMs && safeStr(c.targetIso).match(/^\d{10,13}$/)) {
          const n = parseInt(c.targetIso, 10);
          if (Number.isFinite(n)) c.targetMs = (String(n).length === 10) ? (n * 1000) : n;
          c.targetIso = "";
        }

        return c;
      }

      function cfgFromUrlParams() {
        const on = (P.countdown === "1" || P.countdown === "true");
        if (!on && !P.countdownTo && !P.countdownLabel) return null;

        let targetMs = 0;
        const rawTo = safeStr(P.countdownTo || "");
        if (rawTo) {
          if (/^\d{10,13}$/.test(rawTo)) {
            const n = parseInt(rawTo, 10);
            if (Number.isFinite(n)) targetMs = (String(n).length === 10) ? (n * 1000) : n;
          } else {
            const d = new Date(rawTo);
            const ms = d.getTime();
            if (Number.isFinite(ms) && ms > 0) targetMs = ms;
          }
        }

        return normalizeCfg({
          enabled: on || !!targetMs,
          label: P.countdownLabel || DEFAULTS.label,
          targetMs,
          position: P.countdownPos || "tr"
        });
      }

      function loadCfg() {
        const stored = readJson(CD_KEY) || readJson(CD_KEY_LEGACY);
        const urlCfg = cfgFromUrlParams();
        return normalizeCfg(stored || urlCfg || DEFAULTS);
      }

      let CFG = loadCfg();

      const root = qs("#rlcCountdown");
      const elLbl = qs("#rlcCountdownLabel");
      const elTime = qs("#rlcCountdownTime");
      const hud = qs("#hud");

      function setPos(pos) {
        if (!root) return;
        root.classList.remove("tr","tl","br","bl");
        root.classList.add(pos || "tr");
      }

      function show(on) {
        if (!root) return;
        root.classList.toggle("hidden", !on);
      }

      function nextNewYearLocalMs() {
        try {
          const now = new Date();
          const y = now.getFullYear() + 1;
          return new Date(y, 0, 1, 0, 0, 0, 0).getTime();
        } catch (_) { return 0; }
      }

      let targetMs = 0;

      function applyCfg(cfg) {
        CFG = normalizeCfg(cfg);

        if (elLbl) elLbl.textContent = CFG.label || DEFAULTS.label;
        setPos(CFG.position || "tr");

        // target: prefer targetMs, fallback targetIso, fallback next new year if enabled
        targetMs = CFG.targetMs || 0;

        if (!targetMs && CFG.targetIso) {
          const d = new Date(CFG.targetIso);
          const ms = d.getTime();
          if (Number.isFinite(ms) && ms > 0) targetMs = ms;
        }

        if (!targetMs && CFG.enabled) targetMs = nextNewYearLocalMs();

        show(!!(CFG.enabled && targetMs > 0));
      }

      function fmtRemain(ms) {
        ms = Math.max(0, ms|0);
        const sec = (ms / 1000) | 0;
        const d = (sec / 86400) | 0;
        const h = ((sec % 86400) / 3600) | 0;
        const m = ((sec % 3600) / 60) | 0;
        const s = sec % 60;
        const pad = (n) => String(n).padStart(2,"0");
        if (d > 0) return `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
      }

      function isCatalogOn() {
        const c = qs("#rlcCatalog");
        return !!(c && c.classList.contains("on"));
      }

      function tick() {
        try {
          if (hud && CFG.hideHudWhenCatalog) {
            hud.style.display = isCatalogOn() ? "none" : "";
          }
        } catch (_) {}

        if (!root || root.classList.contains("hidden")) return;
        if (!targetMs) return;

        const ms = targetMs - Date.now();

        if (ms <= 0) {
          if (elTime) elTime.textContent = "üéâ 00:00:00";
          if (elLbl) elLbl.textContent = "FELIZ A√ëO NUEVO";
          return;
        }

        if (elTime) elTime.textContent = fmtRemain(ms);
      }

      function onBusMessage(msg, isMain) {
        if (!msg || typeof msg !== "object") return;

        // ‚úÖ Mensaje desde control.js: { type:"COUNTDOWN_CFG", cfg:{enabled,label,targetMs} }
        if (msg.type === "COUNTDOWN_CFG" && msg.cfg && typeof msg.cfg === "object") {
          if (!keyOk(msg, isMain)) return;
          applyCfg(msg.cfg);
          return;
        }

        // ‚úÖ Si en alg√∫n momento lo mandas como cmd por BC
        if (msg.type === "cmd" && msg.cmd === "COUNTDOWN_SET" && msg.payload && typeof msg.payload === "object") {
          if (!keyOk(msg, isMain)) return;
          applyCfg(msg.payload);
          return;
        }
      }

      if (bcMain) bcMain.onmessage = (ev) => onBusMessage(ev?.data, true);
      if (bcLegacy) bcLegacy.onmessage = (ev) => onBusMessage(ev?.data, false);

      window.addEventListener("storage", (e) => {
        if (!e || !e.key) return;
        if (e.key === CD_KEY || e.key === CD_KEY_LEGACY) applyCfg(loadCfg());
      });

      function boot() {
        applyCfg(loadCfg());
        tick();
        setInterval(tick, 250);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot, { once: true });
      } else {
        boot();
      }
    })();
  </script>
</body>
</html>

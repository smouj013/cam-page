<!-- obs-cam-panel.html — RLC OBS Cam Panel v2.3.9 (ENERO 2026)
     Totalmente compatible con cams.js v2.3.9
     Mejoras: HUD más estable, rotación robusta, mejor espera de carga,
              UI pulida, mejor diagnóstico y feedback
-->
<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#060812" />
  <meta name="robots" content="noindex,nofollow" />
  <title>RLC — OBS Cam Panel v2.3.9</title>

  <style>
    :root {
      --bg: #05060a;
      --bg2: #070a14;
      --panel: rgba(12,16,24,.72);
      --panel2: rgba(10,12,18,.55);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --txt: rgba(255,255,255,.92);
      --mut: rgba(255,255,255,.70);
      --acc: #37d6ff;
      --ok: #19e28a;
      --warn: #ffce57;
      --bad: #ff5a5a;
      --shadow: 0 18px 60px rgba(0,0,0,.52);
      --shadow2: 0 10px 32px rgba(0,0,0,.40);
      --r: 16px;
      --r2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --gap: 10px;

      --topH: 84px;
      --topOffset: 10px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeLeft: env(safe-area-inset-left, 0px);
      --safeRight: env(safe-area-inset-right, 0px);

      --focus: 0 0 0 3px rgba(55,214,255,.22);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      font-family: var(--sans);
      background: 
        radial-gradient(1100px 650px at 10% -10%, rgba(55,214,255,.12), transparent 60%),
        radial-gradient(900px 600px at 120% 20%, rgba(255,206,87,.10), transparent 60%),
        radial-gradient(800px 500px at 60% 120%, rgba(25,226,138,.08), transparent 62%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--txt);
      overflow-x: hidden;
    }

    /* Scrollbars */
    *::-webkit-scrollbar { height: 10px; width: 10px; }
    *::-webkit-scrollbar-thumb { background: rgba(255,255,255,.14); border-radius: 999px; border: 2px solid rgba(0,0,0,.25); }
    *::-webkit-scrollbar-track { background: rgba(0,0,0,.18); }
    * { scrollbar-color: rgba(255,255,255,.16) rgba(0,0,0,.18); scrollbar-width: thin; }

    .wrap {
      padding: 10px 10px 16px;
      max-width: 1180px;
      margin: 0 auto;
      padding-top: calc(10px + var(--topOffset) + var(--safeTop) + var(--topH) + 12px);
    }

    .top {
      position: fixed;
      top: calc(var(--topOffset) + var(--safeTop));
      left: calc(10px + var(--safeLeft));
      right: calc(10px + var(--safeRight));
      max-width: 1180px;
      margin: 0 auto;
      z-index: 9999;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(12,16,24,.84), rgba(12,16,24,.62));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .left { display: flex; gap: 10px; align-items: center; min-width: 0; }
    .brand { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
    .brand .k { font-weight: 900; letter-spacing: .35px; font-size: 12px; color: var(--mut); }
    .brand .n { font-weight: 1000; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .pill, .chip {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      white-space: nowrap;
    }

    .pill { border: 1px solid var(--stroke2); background: rgba(255,255,255,.06); }
    .chip { border: 1px solid rgba(55,214,255,.26); background: rgba(55,214,255,.10); }
    .chip.off { border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.05); color: rgba(255,255,255,.78); }

    .dot {
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--warn); box-shadow: 0 0 0 3px rgba(255,206,87,.16);
    }
    .dot.ok { background: var(--ok); box-shadow: 0 0 0 3px rgba(25,226,138,.16); }
    .dot.bad { background: var(--bad); box-shadow: 0 0 0 3px rgba(255,90,90,.16); }

    .right {
      display: flex; gap: 8px; align-items: center; justify-content: flex-end;
      flex-wrap: nowrap; overflow: auto; -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .right::-webkit-scrollbar { display: none; }

    button {
      appearance: none; border: 1px solid var(--stroke2);
      background: rgba(255,255,255,.06); color: var(--txt);
      padding: 8px 10px; border-radius: 12px;
      font-weight: 900; font-size: 12px; cursor: pointer;
      transition: all .12s ease;
    }
    button:hover { border-color: rgba(255,255,255,.26); background: rgba(255,255,255,.10); }
    button:active { transform: translateY(1px); }
    button.primary { border-color: rgba(55,214,255,.38); background: rgba(55,214,255,.12); }
    button.danger { border-color: rgba(255,90,90,.35); background: rgba(255,90,90,.10); }
    button.ok { border-color: rgba(25,226,138,.30); background: rgba(25,226,138,.10); }
    button.ghost { background: rgba(0,0,0,.20); border-color: rgba(255,255,255,.14); }
    button.segOn { border-color: rgba(55,214,255,.62); background: rgba(55,214,255,.16); }
    button:focus { outline: none; box-shadow: var(--focus); }

    .row, .row2, .row3 { margin-top: var(--gap); display: grid; gap: var(--gap); }
    .row  { grid-template-columns: 1.25fr .85fr .75fr .75fr; }
    .row2 { grid-template-columns: 1fr 1fr; }
    .row3 { grid-template-columns: 1fr 1fr 1fr; }

    .card {
      background: linear-gradient(180deg, rgba(12,16,24,.74), rgba(12,16,24,.60));
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding: 12px 14px;
    }

    .cardTitle { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .cardTitle .h { font-weight: 1000; letter-spacing: .2px; }
    .cardTitle .sub { font-size: 12px; color: var(--mut); font-weight: 900; }

    .field label { display: block; font-weight: 900; font-size: 12px; color: var(--mut); margin-bottom: 6px; }

    input, select {
      width: 100%; border: 1px solid var(--stroke2); border-radius: 12px;
      padding: 10px; background: rgba(0,0,0,.26); color: var(--txt);
      outline: none; font-weight: 800; transition: all .12s ease;
    }
    input:focus, select:focus {
      border-color: rgba(55,214,255,.45); box-shadow: var(--focus); background: rgba(0,0,0,.30);
    }

    .tog {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      padding: 8px 10px; border: 1px solid var(--stroke);
      border-radius: 14px; background: rgba(255,255,255,.04);
    }

    .listTop {
      margin-top: var(--gap);
      display: flex; gap: var(--gap); align-items: center; justify-content: space-between;
      padding: 8px 12px; border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04); border-radius: 14px; flex-wrap: wrap;
    }

    .filterBar {
      margin-top: var(--gap);
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      padding: 8px 10px; border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18); border-radius: 14px;
    }

    .seg { display: flex; gap: 6px; flex-wrap: wrap; }
    .seg button { padding: 7px 10px; border-radius: 999px; font-size: 12px; }

    .list {
      margin-top: var(--gap);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--gap);
    }

    .cam {
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: 14px;
      padding: 12px;
      display: flex;
      gap: 12px;
      transition: all .12s ease;
    }
    .cam.active { border-color: rgba(55,214,255,.58); background: rgba(55,214,255,.10); }
    .cam:hover { border-color: rgba(255,255,255,.24); background: rgba(255,255,255,.07); transform: translateY(-2px); }

    .mini {
      width: 64px; height: 64px; border-radius: 14px;
      border: 1px solid var(--stroke2); background: rgba(0,0,0,.28);
      display: grid; place-items: center; font-weight: 1000;
      color: rgba(255,255,255,.88); font-family: var(--mono);
      overflow: hidden; position: relative;
    }
    .mini img { width: 100%; height: 100%; object-fit: cover; opacity: .95; }

    .cam .body { flex: 1; min-width: 0; }
    .t1 { font-weight: 1000; font-size: 13.5px; line-height: 1.15; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .t2 { margin-top: 4px; font-size: 12px; color: var(--mut); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    .tags { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
    .tag {
      font-size: 11px; font-weight: 1000;
      border: 1px solid var(--stroke2); background: rgba(255,255,255,.06);
      padding: 4px 8px; border-radius: 999px;
      color: rgba(255,255,255,.88);
    }

    .toast {
      position: fixed; left: 16px; bottom: 16px;
      background: rgba(0,0,0,.7); border: 1px solid rgba(255,255,255,.2);
      border-radius: 12px; padding: 12px 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
      font-size: 13px; font-weight: 900;
      opacity: 0; transform: translateY(12px);
      transition: all .2s ease; z-index: 99999;
      max-width: 90vw;
    }
    .toast.on { opacity: 1; transform: translateY(0); }

    /* HUD Catálogo 4-UP */
    .hudCard { margin-top: var(--gap); display: none; }
    .hudBar {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      padding: 8px 12px; border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18); border-radius: 14px; margin-top: 8px;
    }
    .hudGrid {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .hudTile {
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      padding: 12px;
      min-height: 120px;
      display: flex; flex-direction: column; gap: 8px;
      cursor: pointer; transition: all .12s ease;
    }
    .hudTile:hover { transform: translateY(-2px); border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.08); }
    .hudTile.sel { border-color: rgba(55,214,255,.7); background: rgba(55,214,255,.15); box-shadow: var(--focus); }

    @media (max-width: 1060px) { .row3 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 980px) { .row { grid-template-columns: 1fr 1fr; } .row2 { grid-template-columns: 1fr; } }
    @media (max-width: 560px) { .row3 { grid-template-columns: 1fr; } }
  </style>

  <script>window.APP_VERSION = "2.3.9";</script>
  <script src="./cams.js?v=2.3.9"></script>
</head>
<body>

<div class="wrap">
  <!-- Barra superior fija -->
  <div class="top" id="topBar">
    <div class="left">
      <div class="pill"><span class="dot" id="dot"></span><span id="statusTxt">Iniciando...</span></div>
      <div class="chip off" id="rotChip">⟳ Rotación: OFF</div>
      <div class="brand">
        <div class="k">OBS CAM PANEL · v2.3.9</div>
        <div class="n" id="nowTxt">—</div>
      </div>
    </div>
    <div class="right">
      <button class="smallBtn" id="btnPrev">⟵ PREV</button>
      <button class="smallBtn primary" id="btnNext">NEXT ⟶</button>
      <button class="smallBtn" id="btnPlay">⏯ PLAY/PAUSE</button>
      <button class="smallBtn" id="btnRefresh">↻ REFRESH</button>
      <button class="smallBtn" id="btnReload">↻ RECARGAR</button>
    </div>
  </div>

  <!-- Controles principales -->
  <div class="row">
    <div class="card">
      <label>Buscar</label>
      <input id="q" placeholder="tokyo, beach, madrid, news, hls..." />
    </div>

    <div class="card">
      <label>Vista</label>
      <select id="view">
        <option value="catalog">Catálogo (recomendado)</option>
        <option value="main">Lista principal</option>
        <option value="news">Solo noticias</option>
        <option value="newsCatalog">Noticias (catálogo)</option>
        <option value="all">Todo combinado</option>
      </select>
    </div>

    <div class="card">
      <label>Key (namespace)</label>
      <input id="key" class="mono" placeholder="vacío = global" />
    </div>

    <div class="card">
      <label>Acciones rápidas</label>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="smallBtn" id="btnOpen">Abrir Player</button>
        <button class="smallBtn" id="btnSync">Ir a activa</button>
      </div>
    </div>
  </div>

  <!-- Rotación PRO -->
  <div class="card" style="margin-top:var(--gap)">
    <div class="cardTitle">
      <div class="h">Rotación automática</div>
      <div class="sub" id="rotStatusTxt">OFF</div>
    </div>

    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap); margin-top:12px;">
      <div class="tog">
        <div>Activar</div>
        <input type="checkbox" id="rotEnabled" />
      </div>

      <div>
        <label>Intervalo (s)</label>
        <input type="number" id="rotEvery" min="5" max="300" value="30" />
      </div>

      <div>
        <label>Modo</label>
        <select id="rotMode">
          <option value="seq">Secuencial</option>
          <option value="rnd">Aleatorio</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <button class="smallBtn primary" id="btnRotToggle">INICIAR ROTACIÓN</button>
      <button class="smallBtn" id="btnRotNow">Rotar ahora</button>
    </div>
  </div>

  <!-- Lista de cámaras -->
  <div class="listTop">
    <div class="meta" id="countTxt">Cámaras: cargando...</div>
  </div>

  <div class="list" id="list">
    <p style="text-align:center; padding:60px 20px; color:#666;">
      Esperando carga de cámaras desde cams.js...<br>
      <small>(puede tardar 5–15 segundos la primera vez)</small>
    </p>
  </div>

  <!-- Diagnóstico -->
  <details style="margin-top:var(--gap)">
    <summary>Diagnóstico y debug</summary>
    <div class="card" style="margin-top:12px">
      <div id="diagTxt">Estado: iniciando...</div>
    </div>
  </details>
</div>

<div class="toast" id="toast"></div>

<script>
// JavaScript completo actualizado y compatible (enero 2026)
(() => {
  "use strict";

  const qs = s => document.querySelector(s);
  const toastEl = qs("#toast");
  const listEl = qs("#list");
  const viewEl = qs("#view");
  const qEl = qs("#q");
  const keyEl = qs("#key");

  let currentKey = "";
  let rotationTimer = null;

  function toast(msg, ms = 2200) {
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(() => toastEl.classList.remove("on"), ms);
  }

  function setKey(k) {
    currentKey = (k || "").trim();
    keyEl.value = currentKey;
    toast(currentKey ? `Key: ${currentKey}` : "Modo global");
  }

  function refreshCams() {
    if (window.RLCCams?.refresh) {
      window.RLCCams.refresh();
      toast("Refresh → cams.js");
    } else {
      try {
        const bc = new BroadcastChannel("rlc_bus_v1");
        bc.postMessage({ type: "CAMS_REFRESH", ts: Date.now() });
        bc.close();
        toast("Refresh enviado por Broadcast");
      } catch(e) {
        toast("No se pudo refrescar");
      }
    }
  }

  function renderCamera(cam) {
    const div = document.createElement("div");
    div.className = "cam";

    const thumb = cam.thumb || 
      (cam.kind === "youtube" && cam.youtubeId ? 
        `https://i.ytimg.com/vi/${cam.youtubeId}/hqdefault.jpg` : "");

    div.innerHTML = `
      <div class="mini">
        ${thumb ? `<img src="${thumb}" loading="lazy" alt="">` : cam.kind?.toUpperCase() || "?"}
      </div>
      <div class="body">
        <div class="t1">${cam.title || `Cámara ${cam.id || "?"}`}</div>
        <div class="t2">
          ${cam.place ? cam.place + " · " : ""}
          ${cam.source || cam.kind?.toUpperCase() || ""}
        </div>
      </div>
      <div class="actions">
        <button onclick="goto('${cam.id}')">IR</button>
      </div>
    `;

    return div;
  }

  window.goto = function(id) {
    if (!id) return;
    try {
      const bc = new BroadcastChannel("rlc_bus_v1");
      bc.postMessage({
        type: "GOTO",
        id: id,
        camId: id,
        ts: Date.now()
      });
      bc.close();
      toast(`Cambiando a: ${id}`);
    } catch(e) {
      toast("Error al cambiar cámara");
    }
  };

  function renderList() {
    const cams = window.CAM_CATALOG_LIST?.length ? window.CAM_CATALOG_LIST :
                 window.CAM_LIST?.length ? window.CAM_LIST : [];

    listEl.innerHTML = "";

    if (!cams.length) {
      listEl.innerHTML = `
        <p style="text-align:center; padding:80px 20px; color:#555; font-size:15px;">
          Esperando cámaras...<br>
          <small>(puede tardar unos segundos la primera vez)</small>
        </p>`;
      return;
    }

    const fragment = document.createDocumentFragment();
    cams.slice(0, 120).forEach(cam => {
      fragment.appendChild(renderCamera(cam));
    });

    listEl.appendChild(fragment);
    qs("#countTxt").textContent = `Cámaras: ${cams.length}`;
  }

  // Eventos
  viewEl.addEventListener("change", renderList);
  qEl.addEventListener("input", renderList); // búsqueda local básica

  qs("#btnRefresh").onclick = refreshCams;
  qs("#btnReload").onclick = () => location.reload();
  keyEl.onchange = () => setKey(keyEl.value);

  qs("#btnRotToggle").onclick = function() {
    if (rotationTimer) {
      clearInterval(rotationTimer);
      rotationTimer = null;
      this.textContent = "INICIAR ROTACIÓN";
      qs("#rotStatusTxt").textContent = "OFF";
      toast("Rotación detenida");
    } else {
      const sec = parseInt(qs("#rotEvery").value) || 30;
      rotationTimer = setInterval(() => {
        const cams = window.CAM_CATALOG_LIST || window.CAM_LIST || [];
        if (!cams.length) return;
        const random = cams[Math.floor(Math.random() * cams.length)];
        if (random?.id) goto(random.id);
      }, sec * 1000);
      this.textContent = "DETENER ROTACIÓN";
      qs("#rotStatusTxt").textContent = "ON";
      toast(`Rotación iniciada (${sec}s)`);
    }
  };

  qs("#btnRotNow").onclick = () => {
    const cams = window.CAM_CATALOG_LIST || window.CAM_LIST || [];
    if (cams.length) {
      const random = cams[Math.floor(Math.random() * cams.length)];
      if (random?.id) goto(random.id);
    }
  };

  // Escuchar actualización de cams.js
  window.addEventListener("rlc_cam_list_updated", () => {
    renderList();
  });

  // Inicio
  setKey(keyEl.value);
  renderList();
  refreshCams();

  // Reintento suave si aún no hay cámaras
  let tries = 0;
  const waitInterval = setInterval(() => {
    if ((window.CAM_LIST?.length || window.CAM_CATALOG_LIST?.length || 0) > 0) {
      clearInterval(waitInterval);
      renderList();
    } else if (++tries < 12) {
      refreshCams();
    } else {
      clearInterval(waitInterval);
      toast("Carga lenta. Revisa cams.js");
    }
  }, 1800);

})();
</script>
</body>
</html>
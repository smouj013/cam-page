<!-- obs-cam-panel.html — RLC OBS Cam Panel (Hardened + cams.js v2.3.8 compatible + NEWS optional)
  ✅ Compatible con tu cams.js v2.3.8:
     - CAM_LIST / CAM_CATALOG_LIST / CAM_NEWS_LIST
     - Evento: rlc_cam_list_updated (detail.list/catalog/news/newsCatalog + flags)
     - API: window.RLCCams.* (refresh/clearCache/setTarget/setAutoDiscovery/setValidateEmbed + News setters)
     - Mensajes BC: CAMS_REFRESH / CAMS_CLEAR_CACHE / CAMS_SET_* (webcams + news)
  ✅ Control por CMD/STATE multi-compat (v5→v1→legacy) + highlight cam activa
  ✅ Panel de lista mejorado: vista MAIN/CAT/NEWS/NEWS_CATALOG, thumbs YouTube, tags, favs
  ✅ Toggle News ON/OFF y opciones (mix/catalog/target) + “Aplicar y refrescar”
-->
<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#060812" />
  <meta name="robots" content="noindex,nofollow" />
  <title>RLC — OBS Cam Panel</title>

  <style>
    :root{
      --bg:#05060a; --bg2:#070a14;
      --panel:rgba(12,16,24,.70);
      --stroke:rgba(255,255,255,.12);
      --stroke2:rgba(255,255,255,.18);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.70);
      --acc:#37d6ff;
      --ok:#19e28a;
      --warn:#ffce57;
      --bad:#ff5a5a;
      --shadow:0 14px 44px rgba(0,0,0,.45);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 10% -10%, rgba(55,214,255,.10), transparent 60%),
                  radial-gradient(900px 600px at 120% 20%, rgba(255,206,87,.08), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--txt);
    }
    .wrap{padding:10px 10px 14px; max-width:1120px; margin:0 auto;}
    .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:var(--r);
      background:var(--panel); border:1px solid var(--stroke); box-shadow:var(--shadow);
    }
    .left{display:flex; gap:10px; align-items:center; min-width:0}
    .brand{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .brand .k{font-weight:900; letter-spacing:.3px; font-size:12px; color:var(--mut)}
    .brand .n{font-weight:1000; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      font-weight:900; font-size:12px;
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:99px; background:var(--warn); box-shadow:0 0 0 3px rgba(255,206,87,.16)}
    .dot.ok{background:var(--ok); box-shadow:0 0 0 3px rgba(25,226,138,.16)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,90,90,.16)}
    .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    button{
      appearance:none; border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:8px 10px; border-radius:12px;
      font-weight:900; font-size:12px;
      cursor:pointer;
    }
    button:hover{border-color:rgba(255,255,255,.24); background:rgba(255,255,255,.09)}
    button:active{transform:translateY(1px)}
    button.primary{border-color:rgba(55,214,255,.35); background:rgba(55,214,255,.10);}
    button.danger{border-color:rgba(255,90,90,.35); background:rgba(255,90,90,.10);}
    button.ok{border-color:rgba(25,226,138,.28); background:rgba(25,226,138,.10);}
    .row{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1.25fr .85fr .75fr .75fr;
      gap:10px;
    }
    .row2{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:10px 12px;
      min-width:0;
    }
    .field label{
      display:block;
      font-weight:900;
      font-size:12px;
      color:var(--mut);
      margin-bottom:6px;
    }
    input, select, textarea{
      width:100%;
      border:1px solid var(--stroke2);
      border-radius:12px;
      padding:10px 10px;
      background:rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
      font-weight:800;
    }
    input[type="checkbox"]{ width:auto; }
    textarea{min-height:76px; resize:vertical; font-family:var(--mono); font-weight:700;}
    .mono{font-family:var(--mono)}
    .hint{margin-top:6px; font-size:12px; color:var(--mut); line-height:1.25}
    .grid2{display:grid; gap:10px; grid-template-columns: 1fr 1fr;}
    .grid3{display:grid; gap:10px; grid-template-columns: 1fr 1fr 1fr;}
    .tog{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:8px 10px; border:1px solid var(--stroke);
      border-radius:14px; background:rgba(255,255,255,.04);
    }
    .tog .l{display:flex; flex-direction:column; gap:2px; min-width:0}
    .tog .t{font-weight:1000; font-size:12px; color:rgba(255,255,255,.90)}
    .tog .s{font-weight:900; font-size:12px; color:var(--mut)}
    .tog input{transform:scale(1.1)}
    .listTop{
      margin-top:10px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      flex-wrap:wrap;
    }
    .listTop .meta{font-size:12px; color:var(--mut); font-weight:900}
    .listTop .meta b{color:rgba(255,255,255,.88)}
    .list{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .cam{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-width:0;
    }
    .cam.active{border-color:rgba(55,214,255,.48); background:rgba(55,214,255,.08)}
    .mini{
      flex:0 0 auto;
      width:54px; height:54px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background:rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-weight:1000;
      color:rgba(255,255,255,.88);
      font-family:var(--mono);
      position:relative;
      overflow:hidden;
    }
    .mini img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      opacity:.92;
    }
    .mini .badge{
      position:absolute;
      left:6px; top:6px;
      font-size:11px;
      font-weight:1000;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .cam .body{min-width:0; flex:1 1 auto}
    .t1{
      font-weight:1000;
      font-size:13px;
      line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .t2{
      margin-top:3px;
      font-size:12px;
      color:var(--mut);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tags{margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;}
    .tag{
      font-size:11px; font-weight:1000;
      border:1px solid var(--stroke2);
      background:rgba(255,255,255,.06);
      padding:4px 7px;
      border-radius:999px;
      color:rgba(255,255,255,.86);
      max-width:100%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tag.kind{border-color:rgba(255,255,255,.22); background:rgba(0,0,0,.22)}
    .tag.src{border-color:rgba(55,214,255,.22); background:rgba(55,214,255,.08)}
    .tag.place{border-color:rgba(255,206,87,.22); background:rgba(255,206,87,.08)}
    .tag.news{border-color:rgba(255,90,90,.22); background:rgba(255,90,90,.10)}
    .tag.alt{border-color:rgba(255,255,255,.18); background:rgba(0,0,0,.18)}
    .cam .actions{flex:0 0 auto; display:flex; flex-direction:column; gap:8px; align-items:stretch;}
    .smallBtn{padding:7px 9px; border-radius:12px; font-size:12px; font-weight:1000;}
    .star{border-color:rgba(255,206,87,.28); background:rgba(255,206,87,.10);}
    .star.on{border-color:rgba(255,206,87,.52); background:rgba(255,206,87,.18);}
    details{margin-top:10px;}
    summary{cursor:pointer; font-weight:1000; color:rgba(255,255,255,.86)}
    .diag{margin-top:8px; font-size:12px; color:var(--mut); line-height:1.35}
    .diag b{color:rgba(255,255,255,.86)}
    .toast{
      position:fixed; left:12px; bottom:12px;
      background:rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 10px 34px rgba(0,0,0,.55);
      font-size:12px; font-weight:900;
      opacity:0; transform:translateY(8px);
      transition:opacity .18s ease, transform .18s ease;
      pointer-events:none;
      max-width:min(560px, calc(100vw - 24px));
      z-index:9999;
    }
    .toast.on{opacity:1; transform:translateY(0)}
    @media (max-width:980px){
      .row{grid-template-columns:1fr 1fr;}
      .list{grid-template-columns:1fr;}
      .row2{grid-template-columns:1fr;}
    }
  </style>

  <!-- Carga cams.js (ideal: window.CAM_LIST, window.RLCCams, evento rlc_cam_list_updated) -->
  <script src="./cams.js"></script>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="left">
        <div class="pill"><span class="dot" id="dot"></span><span id="statusTxt">Buscando state…</span></div>
        <div class="brand">
          <div class="k">OBS CAM PANEL</div>
          <div class="n" id="nowTxt">—</div>
        </div>
      </div>
      <div class="right">
        <button class="smallBtn" id="btnPrev">⟵ PREV</button>
        <button class="smallBtn primary" id="btnNext">NEXT ⟶</button>
        <button class="smallBtn" id="btnPlay">⏯ PLAY</button>
        <button class="smallBtn" id="btnRefresh">↻ REFRESH (cams.js)</button>
        <button class="smallBtn" id="btnReload">↻ RECARGAR LISTA</button>
      </div>
    </div>

    <div class="row">
      <div class="card field">
        <label>Buscar</label>
        <input id="q" placeholder="Busca: tokyo, beach, nasa, madrid, hls, youtube, news…" />
        <div class="hint">Resalta la cámara activa si detecta <span class="mono">state</span>. “IR” manda comando al player.</div>
      </div>

      <div class="card field">
        <label>Vista + Filtro</label>
        <div class="grid2">
          <select id="view">
            <option value="catalog">Catálogo (sin ALT)</option>
            <option value="main">Main (puede incluir ALT)</option>
            <option value="news">News</option>
            <option value="newsCatalog">News (catálogo)</option>
          </select>
          <select id="kind">
            <option value="">Todos</option>
            <option value="youtube">YouTube</option>
            <option value="hls">HLS</option>
            <option value="other">Otros</option>
          </select>
        </div>
        <div class="hint">Para que no se te “infle” la lista, usa <b>Catálogo</b> (sin ALT).</div>
      </div>

      <div class="card field">
        <label>Key (namespacing)</label>
        <input id="key" class="mono" placeholder="vacío = sin key" />
        <div class="hint">allowLegacy: <span id="legacyTxt">1</span> · bus: v5→v1→legacy</div>
      </div>

      <div class="card field">
        <label>Player</label>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button class="smallBtn" id="btnOpen">Abrir player</button>
          <button class="smallBtn" id="btnSync">Ir a activa</button>
          <button class="smallBtn ok" id="btnSendCamsCfg">Aplicar config → (BC)</button>
        </div>
        <div class="hint">Si NO aparece state, probablemente OBS no comparte storage entre Dock y BrowserSource.</div>
      </div>
    </div>

    <div class="row2">
      <div class="card">
        <div class="diag"><b>Opciones cams.js (webcams)</b></div>
        <div class="grid3" style="margin-top:10px">
          <div class="field">
            <label>Target cams</label>
            <input id="camsTarget" type="number" min="50" max="2500" step="10" value="650" class="mono"/>
            <div class="hint">Equivale a <span class="mono">?camsTarget=</span></div>
          </div>
          <div class="tog">
            <div class="l">
              <div class="t">Auto-discovery</div>
              <div class="s">Buscar más webcams LIVE</div>
            </div>
            <input id="camsDiscovery" type="checkbox" />
          </div>
          <div class="tog">
            <div class="l">
              <div class="t">Validar embed</div>
              <div class="s">Más “limpio”, más requests</div>
            </div>
            <input id="camsValidate" type="checkbox" />
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="smallBtn primary" id="btnApplyCams">Aplicar & Refresh</button>
          <button class="smallBtn" id="btnClearCache">Limpiar cache</button>
          <button class="smallBtn" id="btnPickFeatured">Random Featured (4)</button>
        </div>
        <div class="hint">Estas opciones usan <span class="mono">window.RLCCams</span> si existe; si no, se quedan en modo “solo lectura”.</div>
      </div>

      <div class="card">
        <div class="diag"><b>Noticieros (opcional)</b> <span class="mono">camsNews=1</span></div>
        <div class="grid3" style="margin-top:10px">
          <div class="tog">
            <div class="l">
              <div class="t">News ENABLED</div>
              <div class="s">Genera lista news aparte</div>
            </div>
            <input id="newsEnabled" type="checkbox" />
          </div>
          <div class="tog">
            <div class="l">
              <div class="t">Mix en CAM_LIST</div>
              <div class="s">Meter news en main</div>
            </div>
            <input id="newsMix" type="checkbox" />
          </div>
          <div class="tog">
            <div class="l">
              <div class="t">News en catálogo</div>
              <div class="s">Aparecen en “Catálogo”</div>
            </div>
            <input id="newsInCatalog" type="checkbox" />
          </div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label>News target</label>
            <input id="newsTarget" type="number" min="10" max="300" step="5" value="60" class="mono"/>
            <div class="hint">Equivale a <span class="mono">?camsNewsTarget=</span></div>
          </div>
          <div class="field">
            <label>Tip</label>
            <div class="hint">
              Para que el player cargue news desde URL: <span class="mono">?camsNews=1</span> (y opcional
              <span class="mono">camsNewsMix=1</span> / <span class="mono">camsNewsCatalog=1</span>).
            </div>
          </div>
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="smallBtn primary" id="btnApplyNews">Aplicar News & Refresh</button>
          <button class="smallBtn" id="btnViewNews">Cambiar vista → NEWS</button>
        </div>
      </div>
    </div>

    <div class="listTop">
      <div class="meta" id="countTxt">Cams: —</div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button class="smallBtn" id="btnFavs">★ Solo favoritos</button>
        <button class="smallBtn danger" id="btnClearFavs">✕ Limpiar favs</button>
      </div>
    </div>

    <div class="list" id="list"></div>

    <details>
      <summary>Diagnóstico (por qué no llega al player / estado / buses)</summary>
      <div class="card" style="margin-top:10px">
        <div class="diag" id="diagTxt">—</div>
        <div style="margin-top:10px; display:grid; gap:10px; grid-template-columns:1fr 1fr;">
          <div>
            <div class="diag"><b>Último state (raw)</b></div>
            <textarea id="diagState" readonly></textarea>
          </div>
          <div>
            <div class="diag"><b>Último cmd enviado (raw)</b></div>
            <textarea id="diagCmd" readonly></textarea>
          </div>
        </div>
      </div>
    </details>

  </div>

  <div class="toast" id="toast">—</div>

<script>
(() => {
  "use strict";

  // ───────────────────────── Guard anti doble carga ─────────────────────────
  const LOAD_GUARD = "__RLC_OBS_CAM_PANEL_LOADED_V239";
  try { if (window[LOAD_GUARD]) return; window[LOAD_GUARD] = true; } catch (_) {}

  // ───────────────────────── Utils ─────────────────────────
  const qs = (s, r=document) => r.querySelector(s);
  const now = ()=>Date.now();
  const norm = (s)=>String(s||"").trim().toLowerCase();
  const safeJson = (raw, fb=null) => { try { return JSON.parse(raw); } catch (_) { return fb; } };

  const cssEscape = (s)=>{
    try { return CSS.escape(String(s)); } catch(_){}
    return String(s).replace(/["\\]/g, "\\$&");
  };

  function uuidLike(){
    try { return crypto.randomUUID(); } catch(_){}
    return "n"+Math.random().toString(16).slice(2)+String(Date.now());
  }

  function toast(msg){
    const el = qs("#toast");
    el.textContent = String(msg||"");
    el.classList.add("on");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.classList.remove("on"), 1200);
  }

  function clamp(n,a,b){ n=Number(n); if(!Number.isFinite(n)) n=a; return Math.max(a, Math.min(b, n)); }

  // ───────────────────────── Params ─────────────────────────
  const u = new URL(location.href);

  const allowLegacy = (u.searchParams.get("allowLegacy") == null)
    ? true
    : (u.searchParams.get("allowLegacy")==="1" || u.searchParams.get("allowLegacy")==="true");
  qs("#legacyTxt").textContent = allowLegacy ? "1" : "0";

  const KEY_STORE = "rlc_obs_panel_key_v1";
  const KEY_PARAM = (u.searchParams.get("key") || "").trim();
  const KEY_SAVED = (localStorage.getItem(KEY_STORE) || "").trim();
  let KEY = KEY_PARAM || KEY_SAVED || "";

  const playerUrlParam = (u.searchParams.get("player") || "./index.html").trim();
  qs("#key").value = KEY;

  // ───────────────────────── Candidate keys/channels (player/control) ─────────────────────────
  const BUS_CANDIDATES   = ["rlc_bus_v5","rlc_bus_v4","rlc_bus_v3","rlc_bus_v2","rlc_bus_v1","rlc_bus"];
  const CMD_CANDIDATES   = ["rlc_cmd_v5","rlc_cmd_v4","rlc_cmd_v3","rlc_cmd_v2","rlc_cmd_v1","rlc_cmd"];
  const STATE_CANDIDATES = ["rlc_state_v5","rlc_state_v4","rlc_state_v3","rlc_state_v2","rlc_state_v1","rlc_state"];

  const makeKeyList = (baseList)=>{
    const out = [];
    for (const b of baseList){
      if (KEY) out.push(`${b}:${KEY}`);
      out.push(b);
    }
    if (allowLegacy && KEY){
      for (const b of baseList){
        if (!out.includes(b)) out.push(b);
      }
    }
    return Array.from(new Set(out));
  };

  let BUS_KEYS   = makeKeyList(BUS_CANDIDATES);
  let CMD_KEYS   = makeKeyList(CMD_CANDIDATES);
  let STATE_KEYS = makeKeyList(STATE_CANDIDATES);

  // ───────────────────────── UI refs ─────────────────────────
  const dot = qs("#dot");
  const statusTxt = qs("#statusTxt");
  const nowTxt = qs("#nowTxt");

  const listEl = qs("#list");
  const qEl = qs("#q");
  const kindEl = qs("#kind");
  const viewEl = qs("#view");
  const keyEl = qs("#key");
  const countTxt = qs("#countTxt");

  const btnPrev = qs("#btnPrev");
  const btnNext = qs("#btnNext");
  const btnPlay = qs("#btnPlay");
  const btnReload = qs("#btnReload");
  const btnRefresh = qs("#btnRefresh");
  const btnOpen = qs("#btnOpen");
  const btnSync = qs("#btnSync");
  const btnFavs = qs("#btnFavs");
  const btnClearFavs = qs("#btnClearFavs");

  const camsTargetEl = qs("#camsTarget");
  const camsDiscoveryEl = qs("#camsDiscovery");
  const camsValidateEl = qs("#camsValidate");
  const btnApplyCams = qs("#btnApplyCams");
  const btnClearCache = qs("#btnClearCache");
  const btnPickFeatured = qs("#btnPickFeatured");

  const newsEnabledEl = qs("#newsEnabled");
  const newsMixEl = qs("#newsMix");
  const newsInCatalogEl = qs("#newsInCatalog");
  const newsTargetEl = qs("#newsTarget");
  const btnApplyNews = qs("#btnApplyNews");
  const btnViewNews = qs("#btnViewNews");
  const btnSendCamsCfg = qs("#btnSendCamsCfg");

  const diagTxt = qs("#diagTxt");
  const diagState = qs("#diagState");
  const diagCmd = qs("#diagCmd");

  // ───────────────────────── Storage helpers ─────────────────────────
  function lsGet(k){ try { return localStorage.getItem(k); } catch(_) { return null; } }
  function lsSet(k,v){ try { localStorage.setItem(k,v); } catch(_){} }

  // ───────────────────────── BroadcastChannels (player/control bus) ─────────────────────────
  let bcs = [];
  function closeChannels(){
    for (const c of bcs){ try { c.close(); } catch(_){} }
    bcs = [];
  }
  function openChannels(){
    closeChannels();
    if (!("BroadcastChannel" in window)) return;
    for (const busName of BUS_KEYS){
      try{
        const bc = new BroadcastChannel(busName);
        bc.onmessage = (ev)=>onBus(ev?.data, busName);
        bcs.push(bc);
      } catch(_){}
    }
  }

  // ───────────────────────── BroadcastChannel (cams.js control bus) ─────────────────────────
  // cams.js escucha SIEMPRE "rlc_bus_v1" (sin namespace). Enviamos ahí y, por si acaso, también a "rlc_bus_v1:{KEY}".
  let camsBC = null;
  let camsBCKeyed = null;

  function openCamsBC(){
    try { if (camsBC) camsBC.close(); } catch(_){}
    try { if (camsBCKeyed) camsBCKeyed.close(); } catch(_){}
    camsBC = null; camsBCKeyed = null;

    if (!("BroadcastChannel" in window)) return;

    try { camsBC = new BroadcastChannel("rlc_bus_v1"); } catch(_){}
    try { if (KEY) camsBCKeyed = new BroadcastChannel(`rlc_bus_v1:${KEY}`); } catch(_){}
  }

  function postCamsBC(msg){
    try { if (camsBC) camsBC.postMessage(msg); } catch(_){}
    try { if (camsBCKeyed) camsBCKeyed.postMessage(msg); } catch(_){}
  }

  // ───────────────────────── State parse (multi schema) ─────────────────────────
  let lastState = null;
  let lastSeenAt = 0;
  let lastStateKeyUsed = "";

  function setConn(state){
    dot.classList.remove("ok","bad");
    if (state === true) dot.classList.add("ok");
    else if (state === false) dot.classList.add("bad");
  }

  function pickState(obj){
    if (!obj || typeof obj !== "object") return null;
    if (KEY){
      const mk = String(obj.key||"").trim();
      if (mk && mk !== KEY) return null;
    }
    return obj;
  }

  function readState(){
    lastStateKeyUsed = "";
    for (const k of STATE_KEYS){
      const raw = lsGet(k);
      if (!raw) continue;
      const s = pickState(safeJson(raw, null));
      if (!s) continue;
      lastStateKeyUsed = k;
      return s;
    }
    return null;
  }

  function extractCam(s){
    const cam = (s && typeof s.cam === "object" && s.cam) ? s.cam
      : (s && typeof s.nowCam === "object" && s.nowCam) ? s.nowCam
      : (s && typeof s.currentCam === "object" && s.currentCam) ? s.currentCam
      : null;

    const id = (cam && cam.id != null) ? String(cam.id)
      : (s && s.camId != null) ? String(s.camId)
      : (s && s.currentCamId != null) ? String(s.currentCamId)
      : (s && s.activeCamId != null) ? String(s.activeCamId)
      : "";

    const title = (cam && cam.title) ? String(cam.title)
      : (s && s.camTitle) ? String(s.camTitle)
      : "";

    const place = (cam && cam.place) ? String(cam.place)
      : (s && s.camPlace) ? String(s.camPlace)
      : "";

    const kind = (cam && cam.kind) ? String(cam.kind)
      : (s && s.camKind) ? String(s.camKind)
      : "";

    const source = (cam && cam.source) ? String(cam.source) : "";

    return { id, title, place, kind, source, raw: cam };
  }

  function extractPlaying(s){
    if (!s || typeof s !== "object") return null;
    if (typeof s.playing === "boolean") return s.playing;
    if (typeof s.isPlaying === "boolean") return s.isPlaying;
    if (typeof s.paused === "boolean") return !s.paused;
    return null;
  }

  function renderTopFromState(s){
    const cam = extractCam(s);
    const title = cam.title || (cam.id ? `Cam ${cam.id}` : "—");
    const place = cam.place ? ` — ${cam.place}` : "";
    const kind = cam.kind ? ` · ${cam.kind}` : "";
    nowTxt.textContent = `${title}${place}${kind}`;

    const playing = extractPlaying(s);
    if (playing === true) { statusTxt.textContent = "LIVE"; btnPlay.textContent = "⏸ PAUSE"; }
    else if (playing === false) { statusTxt.textContent = "PAUSA"; btnPlay.textContent = "▶ PLAY"; }
    else { statusTxt.textContent = "STATE OK"; btnPlay.textContent = "⏯ PLAY"; }

    setConn(true);
  }

  function onBus(msg, busName){
    if (!msg || typeof msg !== "object") return;
    const type = String(msg.type || msg.t || "").toLowerCase();
    if (type === "state"){
      const s = pickState(msg);
      if (!s) return;
      lastState = s;
      lastSeenAt = now();
      lastStateKeyUsed = busName || lastStateKeyUsed;
      renderTopFromState(s);
      markActiveCam();
      updateDiag();
    }
  }

  window.addEventListener("storage", (e)=>{
    const k = String(e.key||"");
    if (!k) return;
    if (!STATE_KEYS.includes(k)) return;

    const s = readState();
    if (s){
      lastState = s;
      lastSeenAt = now();
      renderTopFromState(s);
      markActiveCam();
      updateDiag();
    }
  });

  // ───────────────────────── Command send (player/control) ─────────────────────────
  let lastSendAt = 0;
  let lastCmdRaw = "";

  function buildCmdPacket(cmd, payload){
    const t = now();
    const p = payload || {};
    const pkt = {
      type: "cmd",
      t: "cmd",
      ts: t,
      time: t,
      nonce: uuidLike(),
      cmd: String(cmd||""),
      op: String(cmd||""),
      action: String(cmd||""),
      name: String(cmd||""),
      payload: p,
      p: p,
      data: p
    };
    if (KEY) pkt.key = KEY;
    return pkt;
  }

  function sendCmd(cmd, payload={}){
    const t = now();
    if (t - lastSendAt < 60) return;
    lastSendAt = t;

    const pkt = buildCmdPacket(cmd, payload);
    const raw = JSON.stringify(pkt);
    lastCmdRaw = raw;
    diagCmd.value = raw;

    for (const k of CMD_KEYS) lsSet(k, raw);
    for (const bc of bcs){
      try { bc.postMessage(pkt); } catch(_){}
    }

    toast(`CMD → ${cmd}${payload && payload.id!=null ? " ("+payload.id+")" : ""}`);
    updateDiag();
  }

  // ───────────────────────── cams.js list + update events ─────────────────────────
  let lastCamsDetail = null;

  function getListByView(){
    const v = String(viewEl.value || "catalog");
    if (v === "main") return Array.isArray(window.CAM_LIST) ? window.CAM_LIST : [];
    if (v === "catalog") return Array.isArray(window.CAM_CATALOG_LIST) ? window.CAM_CATALOG_LIST : [];
    if (v === "news") return Array.isArray(window.CAM_NEWS_LIST) ? window.CAM_NEWS_LIST : [];
    if (v === "newsCatalog") {
      if (lastCamsDetail && Array.isArray(lastCamsDetail.newsCatalog)) return lastCamsDetail.newsCatalog;
      return Array.isArray(window.CAM_NEWS_LIST) ? window.CAM_NEWS_LIST : [];
    }
    return Array.isArray(window.CAM_CATALOG_LIST) ? window.CAM_CATALOG_LIST : (Array.isArray(window.CAM_LIST) ? window.CAM_LIST : []);
  }

  function applyCamsUiFromDetail(d){
    if (!d || typeof d !== "object") return;

    if (typeof d.target === "number") camsTargetEl.value = String(clamp(d.target, 50, 2500) | 0);
    if (typeof d.autoDiscovery === "boolean") camsDiscoveryEl.checked = d.autoDiscovery;
    if (typeof d.validateEmbed === "boolean") camsValidateEl.checked = d.validateEmbed;

    if (typeof d.newsEnabled === "boolean") newsEnabledEl.checked = d.newsEnabled;
    if (typeof d.newsMix === "boolean") newsMixEl.checked = d.newsMix;
    if (typeof d.newsInCatalog === "boolean") newsInCatalogEl.checked = d.newsInCatalog;
    if (typeof d.newsTarget === "number") newsTargetEl.value = String(clamp(d.newsTarget, 10, 300) | 0);
  }

  window.addEventListener("rlc_cam_list_updated", (ev)=>{
    lastCamsDetail = (ev && ev.detail) ? ev.detail : null;
    applyCamsUiFromDetail(lastCamsDetail);
    renderList();
    updateDiag();
  });

  // Fallback: si cams.js no emitió aún, intentamos leer la API
  function syncUiFromRLCCams(){
    const api = window.RLCCams;
    if (!api) return;

    // Solo lo que sabemos obtener seguro:
    try {
      const t = api.getTarget && api.getTarget();
      if (typeof t === "number") camsTargetEl.value = String(clamp(t, 50, 2500) | 0);
    } catch(_){}
  }

  // ───────────────────────── Favorites ─────────────────────────
  let favOnly = false;
  const FAV_KEY_BASE = "rlc_obs_favs_v1";
  const favStoreKey = ()=> KEY ? `${FAV_KEY_BASE}:${KEY}` : FAV_KEY_BASE;

  function loadFavs(){
    const arr = safeJson(lsGet(favStoreKey()), []);
    return new Set(Array.isArray(arr) ? arr.map(String) : []);
  }
  function saveFavs(set){
    lsSet(favStoreKey(), JSON.stringify(Array.from(set)));
  }
  let favs = loadFavs();

  // ───────────────────────── Render list ─────────────────────────
  function camKindBadge(kind){
    const k = norm(kind);
    if (k === "youtube") return "YT";
    if (k === "hls") return "HLS";
    return "CAM";
  }

  function camText(c){
    return [
      c.id, c.kind, c.title, c.place, c.source, c.originUrl, c.url,
      (Array.isArray(c.tags) ? c.tags.join(" ") : (c.tags || "")),
      (c.tag || ""), (c.category || ""), (c.categories || ""),
      (c.isAlt ? "alt" : ""), (c.altOf || "")
    ].map(x=>String(x||"")).join(" ").toLowerCase();
  }

  function kindFilterOk(c){
    const kf = norm(kindEl.value);
    if (!kf) return true;
    const ck = norm(c.kind);
    if (kf === "other") return ck !== "youtube" && ck !== "hls";
    return ck === kf;
  }

  function queryOk(c){
    const q = norm(qEl.value);
    if (!q) return true;
    return camText(c).includes(q);
  }

  function renderList(customList=null){
    const baseList = Array.isArray(customList) ? customList : getListByView();
    const filtered = baseList
      .filter(c => c && c.id != null)
      .filter(kindFilterOk)
      .filter(queryOk)
      .filter(c => !favOnly || favs.has(String(c.id)));

    const totalMain = (Array.isArray(window.CAM_LIST) ? window.CAM_LIST.length : 0);
    const totalCat  = (Array.isArray(window.CAM_CATALOG_LIST) ? window.CAM_CATALOG_LIST.length : 0);
    const totalNews = (Array.isArray(window.CAM_NEWS_LIST) ? window.CAM_NEWS_LIST.length : 0);

    const v = String(viewEl.value || "catalog");
    const vLabel = (v === "main") ? "MAIN"
      : (v === "catalog") ? "CAT"
      : (v === "news") ? "NEWS"
      : (v === "newsCatalog") ? "NEWS_CAT"
      : "LIST";

    countTxt.innerHTML =
      `Mostrando: <b>${filtered.length}</b> · vista <b>${vLabel}</b>` +
      `${favOnly ? " · ★ favs" : ""}` +
      ` · totals: main=${totalMain}, cat=${totalCat}, news=${totalNews}`;

    listEl.innerHTML = "";
    const frag = document.createDocumentFragment();

    for (const c of filtered){
      const id = String(c.id);
      const el = document.createElement("div");
      el.className = "cam";
      el.dataset.id = id;

      // mini (thumb + badge)
      const mini = document.createElement("div");
      mini.className = "mini";

      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = camKindBadge(c.kind);
      mini.appendChild(badge);

      const thumb = (c && c.thumb) ? String(c.thumb) : "";
      if (thumb) {
        const img = document.createElement("img");
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.alt = "thumb";
        img.src = thumb;
        mini.appendChild(img);
      } else {
        const fallback = document.createElement("div");
        fallback.style.fontSize = "12px";
        fallback.style.opacity = ".9";
        fallback.textContent = camKindBadge(c.kind);
        mini.appendChild(fallback);
      }

      const body = document.createElement("div");
      body.className = "body";

      const t1 = document.createElement("div");
      t1.className = "t1";
      t1.textContent = c.title || `Cam ${id}`;

      const t2 = document.createElement("div");
      t2.className = "t2";
      t2.textContent = `${c.place ? c.place + " · " : ""}${c.source || ""}`.trim() || "—";

      const tags = document.createElement("div");
      tags.className = "tags";

      const tagKind = document.createElement("div");
      tagKind.className = "tag kind";
      tagKind.textContent = (c.kind || "cam");
      tags.appendChild(tagKind);

      const tagId = document.createElement("div");
      tagId.className = "tag";
      tagId.textContent = `id:${id}`;
      tags.appendChild(tagId);

      if (c.source){
        const s = document.createElement("div");
        s.className = "tag src";
        s.textContent = c.source;
        tags.appendChild(s);
      }
      if (c.place){
        const p = document.createElement("div");
        p.className = "tag place";
        p.textContent = c.place;
        tags.appendChild(p);
      }

      // tags extras
      const isNews = Array.isArray(c.tags) ? c.tags.includes("news") : false;
      if (isNews || (String(viewEl.value||"").includes("news"))) {
        const n = document.createElement("div");
        n.className = "tag news";
        n.textContent = "NEWS";
        tags.appendChild(n);
      }
      if (c.isAlt) {
        const a = document.createElement("div");
        a.className = "tag alt";
        a.textContent = `ALT${c.altOf ? ":"+c.altOf : ""}`;
        tags.appendChild(a);
      }

      body.appendChild(t1);
      body.appendChild(t2);
      body.appendChild(tags);

      const actions = document.createElement("div");
      actions.className = "actions";

      const bGo = document.createElement("button");
      bGo.className = "smallBtn primary";
      bGo.textContent = "IR";
      bGo.addEventListener("click", (ev)=>{
        ev.preventDefault();
        sendCmd("GOTO", { id, camId:id, targetId:id });
      });

      const bStar = document.createElement("button");
      bStar.className = "smallBtn star" + (favs.has(id) ? " on" : "");
      bStar.textContent = favs.has(id) ? "★" : "☆";
      bStar.title = "Favorito";
      bStar.addEventListener("click", (ev)=>{
        ev.preventDefault();
        if (favs.has(id)) favs.delete(id);
        else favs.add(id);
        saveFavs(favs);
        renderList();
      });

      const bOpen = document.createElement("button");
      bOpen.className = "smallBtn";
      bOpen.textContent = "ORIG";
      bOpen.title = "Abrir originUrl";
      bOpen.addEventListener("click", (ev)=>{
        ev.preventDefault();
        const url = c.originUrl || c.url || "";
        if (url) window.open(url, "_blank", "noopener");
      });

      actions.appendChild(bGo);
      actions.appendChild(bStar);
      actions.appendChild(bOpen);

      el.appendChild(mini);
      el.appendChild(body);
      el.appendChild(actions);

      frag.appendChild(el);
    }

    listEl.appendChild(frag);
    markActiveCam();
  }

  function markActiveCam(){
    const s = lastState || readState();
    const cam = s ? extractCam(s) : {id:""};
    const activeId = cam && cam.id ? String(cam.id) : "";
    const items = listEl.querySelectorAll(".cam");
    for (const el of items){
      el.classList.toggle("active", !!(activeId && el.dataset.id === activeId));
    }
  }

  function scrollToActive(){
    const s = lastState || readState();
    const cam = s ? extractCam(s) : {id:""};
    const activeId = cam && cam.id ? String(cam.id) : "";
    if (!activeId) return;
    const el = listEl.querySelector(`.cam[data-id="${cssEscape(activeId)}"]`);
    if (el) el.scrollIntoView({ block:"center", behavior:"smooth" });
  }

  // ───────────────────────── cams.js actions ─────────────────────────
  function camsApi(){
    return (window.RLCCams && typeof window.RLCCams === "object") ? window.RLCCams : null;
  }

  function camsRefresh(){
    const api = camsApi();
    if (api && typeof api.refresh === "function"){
      try { api.refresh(); toast("cams.js → refresh()"); return; } catch(_){}
    }
    // fallback: BC msg (para player/otras pestañas)
    postCamsBC({ type:"CAMS_REFRESH", ts: now(), key: KEY || "" });
    toast("CAMS_REFRESH → BC");
  }

  function camsClearCache(){
    const api = camsApi();
    if (api && typeof api.clearCache === "function"){
      try { api.clearCache(); toast("cams.js → clearCache()"); return; } catch(_){}
    }
    postCamsBC({ type:"CAMS_CLEAR_CACHE", ts: now(), key: KEY || "" });
    toast("CAMS_CLEAR_CACHE → BC");
  }

  function applyCamsOptions(){
    const api = camsApi();
    const target = clamp(parseInt(camsTargetEl.value, 10), 50, 2500) | 0;
    const autoDisc = !!camsDiscoveryEl.checked;
    const validate = !!camsValidateEl.checked;

    if (api){
      try { api.setTarget && api.setTarget(target); } catch(_){}
      try { api.setAutoDiscovery && api.setAutoDiscovery(autoDisc); } catch(_){}
      try { api.setValidateEmbed && api.setValidateEmbed(validate); } catch(_){}
    }

    // También mandamos BC para sincronizar a otras páginas con cams.js
    postCamsBC({ type:"CAMS_SET_TARGET", value: target, ts: now(), key: KEY || "" });
    postCamsBC({ type:"CAMS_SET_AUTODISCOVERY", value: autoDisc, ts: now(), key: KEY || "" });
    postCamsBC({ type:"CAMS_SET_VALIDATE", value: validate, ts: now(), key: KEY || "" });

    camsRefresh();
    toast(`Aplicado: target=${target} disc=${autoDisc?1:0} val=${validate?1:0}`);
  }

  function applyNewsOptions(){
    const api = camsApi();
    const en = !!newsEnabledEl.checked;
    const mix = !!newsMixEl.checked;
    const inCat = !!newsInCatalogEl.checked;
    const nTarget = clamp(parseInt(newsTargetEl.value, 10), 10, 300) | 0;

    if (api){
      try { api.setNewsEnabled && api.setNewsEnabled(en); } catch(_){}
      try { api.setNewsMix && api.setNewsMix(mix); } catch(_){}
      try { api.setNewsInCatalog && api.setNewsInCatalog(inCat); } catch(_){}
      try { api.setNewsTarget && api.setNewsTarget(nTarget); } catch(_){}
    }

    postCamsBC({ type:"CAMS_SET_NEWS_ENABLED", value: en, ts: now(), key: KEY || "" });
    postCamsBC({ type:"CAMS_SET_NEWS_MIX", value: mix, ts: now(), key: KEY || "" });
    postCamsBC({ type:"CAMS_SET_NEWS_CATALOG", value: inCat, ts: now(), key: KEY || "" });
    postCamsBC({ type:"CAMS_SET_NEWS_TARGET", value: nTarget, ts: now(), key: KEY || "" });

    camsRefresh();
    toast(`News: en=${en?1:0} mix=${mix?1:0} cat=${inCat?1:0} target=${nTarget}`);
  }

  function pickFeatured4(){
    const api = camsApi();
    if (!api || typeof api.getCatalogFeatured !== "function"){
      toast("RLCCams.getCatalogFeatured no disponible");
      return;
    }
    try {
      const items = api.getCatalogFeatured(4) || [];
      if (Array.isArray(items) && items.length){
        viewEl.value = "catalog";
        renderList(items);
        toast("Mostrando featured (4)");
      }
    } catch(_){
      toast("Error obteniendo featured");
    }
  }

  // ───────────────────────── Controls ─────────────────────────
  btnNext.addEventListener("click", ()=>sendCmd("NEXT"));
  btnPrev.addEventListener("click", ()=>sendCmd("PREV"));

  btnPlay.addEventListener("click", ()=>{
    const s = lastState || readState();
    const playing = extractPlaying(s);
    if (playing === true) sendCmd("PAUSE");
    else if (playing === false) sendCmd("PLAY");
    else sendCmd("TOGGLE_PLAY");
  });

  btnReload.addEventListener("click", ()=>{
    // “recargar lista” = re-render inmediato (y si cams.js actualiza, el evento lo refresca)
    renderList();
    toast("Lista re-render");
  });

  btnRefresh.addEventListener("click", ()=>camsRefresh());

  btnOpen.addEventListener("click", ()=>{
    const base = playerUrlParam || "./index.html";
    const url = new URL(base, location.href);
    if (KEY) url.searchParams.set("key", KEY);
    if (!allowLegacy) url.searchParams.set("allowLegacy", "0");
    window.open(url.toString(), "_blank", "noopener");
  });

  btnSync.addEventListener("click", ()=>scrollToActive());

  btnFavs.addEventListener("click", ()=>{
    favOnly = !favOnly;
    btnFavs.textContent = favOnly ? "★ Mostrando favs" : "★ Solo favoritos";
    renderList();
  });

  btnClearFavs.addEventListener("click", ()=>{
    favs = new Set();
    saveFavs(favs);
    renderList();
  });

  qEl.addEventListener("input", ()=>renderList());
  kindEl.addEventListener("change", ()=>renderList());
  viewEl.addEventListener("change", ()=>renderList());

  // Cams/News apply
  btnApplyCams.addEventListener("click", ()=>applyCamsOptions());
  btnClearCache.addEventListener("click", ()=>camsClearCache());
  btnPickFeatured.addEventListener("click", ()=>pickFeatured4());

  btnApplyNews.addEventListener("click", ()=>applyNewsOptions());
  btnViewNews.addEventListener("click", ()=>{
    viewEl.value = "news";
    renderList();
    toast("Vista → NEWS");
  });

  // Enviar config por BC “a lo bestia” (útil si el player está abierto y BC funciona)
  btnSendCamsCfg.addEventListener("click", ()=>{
    applyCamsOptions();
    applyNewsOptions();
    toast("Config enviada (BC) + refresh");
  });

  // Key change
  keyEl.addEventListener("change", ()=>{
    KEY = (keyEl.value || "").trim();
    localStorage.setItem(KEY_STORE, KEY);

    BUS_KEYS   = makeKeyList(BUS_CANDIDATES);
    CMD_KEYS   = makeKeyList(CMD_CANDIDATES);
    STATE_KEYS = makeKeyList(STATE_CANDIDATES);

    favs = loadFavs();

    openChannels();
    openCamsBC();

    toast(KEY ? `key=${KEY}` : "key vacía");
    renderList();
    updateDiag();
  });

  // ───────────────────────── Diag / watchdog ─────────────────────────
  function updateDiag(){
    const age = lastSeenAt ? (now() - lastSeenAt) : null;
    const ageTxt = (age==null) ? "—" : `${Math.round(age)}ms`;

    const foundState = !!(lastState || readState());
    const stateKey = lastStateKeyUsed || "(no detectado)";
    const busInfo = ("BroadcastChannel" in window) ? `${bcs.length} canales` : "sin BroadcastChannel";
    const origin = location.origin;

    const api = camsApi();
    const camsVer = (api && api.version) ? String(api.version) : "(sin RLCCams)";
    const totals = `CAM_LIST=${Array.isArray(window.CAM_LIST)?window.CAM_LIST.length:0}, ` +
                   `CAT=${Array.isArray(window.CAM_CATALOG_LIST)?window.CAM_CATALOG_LIST.length:0}, ` +
                   `NEWS=${Array.isArray(window.CAM_NEWS_LIST)?window.CAM_NEWS_LIST.length:0}`;

    diagTxt.innerHTML =
      `<b>origin</b>: ${origin}<br>`+
      `<b>KEY</b>: ${KEY ? `<span class="mono">${KEY}</span>` : "(vacía)"} · allowLegacy=${allowLegacy ? "1":"0"}<br>`+
      `<b>STATE</b>: ${foundState ? "sí" : "no"} · <b>age</b>: ${ageTxt} · <b>key usada</b>: <span class="mono">${stateKey}</span><br>`+
      `<b>CMD keys probadas</b>: <span class="mono">${CMD_KEYS.slice(0,6).join(", ")}</span>${CMD_KEYS.length>6?" …":""}<br>`+
      `<b>STATE keys probadas</b>: <span class="mono">${STATE_KEYS.slice(0,6).join(", ")}</span>${STATE_KEYS.length>6?" …":""}<br>`+
      `<b>BUS</b>: ${busInfo} (player/control) · <b>cams.js</b>: <span class="mono">${camsVer}</span><br>`+
      `<b>Listas</b>: ${totals}<br>`+
      `<b>Tip</b>: si estás en OBS y no sincroniza, suele ser por aislamiento de storage/BC entre Dock y BrowserSource.`;

    const s = lastState || readState();
    diagState.value = s ? JSON.stringify(s, null, 2) : "";
    if (!diagCmd.value) diagCmd.value = lastCmdRaw || "";

    // Si tenemos detalle del evento, refrescamos UI de toggles
    if (lastCamsDetail) applyCamsUiFromDetail(lastCamsDetail);
    else syncUiFromRLCCams();
  }

  function tick(){
    const s = readState();
    if (s){
      lastState = s;
      lastSeenAt = now();
      renderTopFromState(s);
    }

    const age = now() - (lastSeenAt || 0);
    if (!lastSeenAt){
      setConn(null);
      statusTxt.textContent = "SIN STATE";
    } else if (age > 8000){
      setConn(false);
      statusTxt.textContent = "STATE VIEJO";
    } else {
      setConn(true);
    }

    markActiveCam();
    updateDiag();
  }

  // ───────────────────────── Boot ─────────────────────────
  openChannels();
  openCamsBC();

  // Estado inicial
  const s0 = readState();
  if (s0){
    lastState = s0;
    lastSeenAt = now();
    renderTopFromState(s0);
  } else {
    statusTxt.textContent = "SIN STATE";
  }

  // UI inicial cams.js (si ya está)
  try {
    // Si cams.js ya emitió antes de que montemos listener (raro), renderizamos igual.
    renderList();
    syncUiFromRLCCams();
  } catch(_){}

  updateDiag();
  setInterval(tick, 750);
})();
</script>
</body>
</html>

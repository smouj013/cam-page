<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Twitch OAuth Return</title>
  <style>
    :root{
      --bg0:#05060b; --bg1:#070b14; --bg2:#0a1528;
      --panel: rgba(10,14,22,.78);
      --stroke: rgba(255,255,255,.12);
      --stroke2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --ok:#19e28a; --bad:#ff5a5a; --acc:#37d6ff;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    body{
      margin:0; min-height:100svh; color:var(--text); font-family:var(--sans);
      background:
        radial-gradient(1200px 900px at 20% 0%, rgba(55,214,255,.14), transparent 55%),
        radial-gradient(900px 700px at 85% 15%, rgba(255,59,59,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none; z-index:0; opacity:.65;
      background:
        radial-gradient(900px 700px at 50% 40%, rgba(0,0,0,.20), rgba(0,0,0,.72)),
        repeating-linear-gradient(0deg, rgba(255,255,255,.05) 0 1px, rgba(255,255,255,0) 1px 3px),
        linear-gradient(90deg, rgba(55,214,255,.08), transparent 35%, rgba(255,59,59,.07));
      mix-blend-mode: screen;
    }
    .wrap{position:relative; z-index:1; padding:24px;}
    .card{
      max-width: 1020px; margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar{
      padding: 16px 18px;
      background: linear-gradient(90deg, rgba(255,59,59,.18), rgba(10,14,22,.88) 25%, rgba(55,214,255,.16));
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{display:flex; flex-direction:column; gap:4px;}
    .kicker{letter-spacing:.26em; font-weight:900; font-size:12px; opacity:.82}
    h1{margin:0; font-size:16px; letter-spacing:.04em; text-transform:uppercase}
    .pill{
      font: 900 12px/1 var(--sans);
      border: 1px solid var(--stroke2);
      background: rgba(0,0,0,.25);
      padding: 8px 10px;
      border-radius: 999px;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .pill.ok{border-color: rgba(25,226,138,.35);}
    .pill.bad{border-color: rgba(255,90,90,.40);}
    .body{padding: 18px;}
    .muted{color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 1.25fr .75fr;}
    }
    .box{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 12px;
      overflow:auto;
    }
    pre{
      margin:0; font-family: var(--mono);
      white-space: pre-wrap; word-break: break-word;
      color: rgba(255,255,255,.92);
    }
    code{font-family:var(--mono)}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    .btn{
      cursor:pointer; border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      letter-spacing:.02em;
      box-shadow: 0 10px 30px rgba(0,0,0,.30);
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(55,214,255,.25); filter: brightness(1.05);}
    .btn.ghost{background: rgba(0,0,0,.18);}
    .btn.full{flex:1 1 220px;}
    .small{font-size:12px}
    .warn{
      margin-top: 12px;
      border-left: 3px solid rgba(255,90,90,.65);
      padding: 10px 12px;
      background: rgba(255,90,90,.08);
      border-radius: 12px;
    }
    .good{
      margin-top: 12px;
      border-left: 3px solid rgba(25,226,138,.55);
      padding: 10px 12px;
      background: rgba(25,226,138,.08);
      border-radius: 12px;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-top: 10px;
    }
    label{font-weight:950; letter-spacing:.02em; font-size:12px; opacity:.9}
    input{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      outline:none;
      font-family: var(--mono);
    }
    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px 10px;
      align-items:center;
    }
    .k{color: rgba(255,255,255,.78); font-weight:900; font-size:12px; letter-spacing:.02em}
    .v{font-family: var(--mono); color: rgba(255,255,255,.92)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="title">
          <div class="kicker">OAUTH CALLBACK</div>
          <h1>✅ Twitch OAuth recibido</h1>
        </div>
        <div id="pill" class="pill">Leyendo respuesta…</div>
      </div>

      <div class="body">
        <p class="muted small" style="margin:0">
          Esta página captura el token devuelto por Twitch (fragmento <code>#</code>) y además intenta
          <b>validarlo</b> para obtener automáticamente tu <b>Broadcaster ID (user_id)</b>.
          Si abriste esto desde tu panel, también lo devuelve al <code>window.opener</code>.
        </p>

        <div class="grid">
          <div>
            <div class="field">
              <label>Redirect URI (este mismo)</label>
              <input id="redirectBox" type="text" readonly />
              <div class="muted small">Añade esta URL EXACTA en tu app de Twitch → <b>OAuth Redirect URLs</b>.</div>
            </div>

            <div class="row">
              <button id="copyRedirectBtn" class="btn ghost full" type="button">Copiar redirect URI</button>
              <button id="closeBtn" class="btn ghost full" type="button">Cerrar</button>
            </div>

            <div id="msgBox" class=""></div>

            <div class="field" style="margin-top:16px">
              <label>Access Token</label>
              <div class="box"><pre id="tokenBox">(vacío)</pre></div>
            </div>

            <div class="field">
              <label>Scopes</label>
              <div class="box"><pre id="scopeBox">(vacío)</pre></div>
            </div>

            <div class="row">
              <button id="copyTokenBtn" class="btn full" type="button">Copiar token</button>
              <button id="copyScopesBtn" class="btn ghost full" type="button">Copiar scopes</button>
            </div>

            <div class="field" style="margin-top:14px">
              <label>Datos del canal (auto por validate)</label>
              <div class="box">
                <div class="kv">
                  <div class="k">Broadcaster ID</div><div class="v" id="broadcasterId">(—)</div>
                  <div class="k">Login</div><div class="v" id="loginName">(—)</div>
                  <div class="k">Client ID</div><div class="v" id="clientIdOut">(—)</div>
                  <div class="k">Expira en</div><div class="v" id="expiresOut">(—)</div>
                </div>
              </div>
            </div>

            <div class="row">
              <button id="copyBroadcasterBtn" class="btn full" type="button">Copiar Broadcaster ID</button>
              <button id="copyLoginBtn" class="btn ghost full" type="button">Copiar login</button>
            </div>

            <div class="warn small">
              ⚠️ No publiques este token en GitHub. Guárdalo en local (localStorage / tu panel admin / config privada).
            </div>
          </div>

          <div>
            <div class="field">
              <label>Generador de URL OAuth (para obtener token)</label>
              <div class="muted small">
                Para auto-título necesitas el scope <code>channel:manage:broadcast</code>.
              </div>
            </div>

            <div class="field">
              <label>Client ID (de tu app de Twitch)</label>
              <input id="clientId" type="text" placeholder="Pega tu Client ID aquí" autocomplete="off"/>
              <div class="muted small">Solo se usa para construir el link de login. (Luego, validate te lo muestra también.)</div>
            </div>

            <div class="field">
              <label>Scopes (separados por espacio)</label>
              <input id="scopes" type="text" value="channel:manage:broadcast" autocomplete="off"/>
            </div>

            <div class="row">
              <button id="openAuthBtn" class="btn full" type="button">Abrir login Twitch</button>
              <button id="copyAuthBtn" class="btn ghost full" type="button">Copiar URL login</button>
            </div>

            <div class="good small">
              Si te sale <b>redirect_mismatch</b>:
              <ul style="margin:8px 0 0; padding-left:18px">
                <li>El <code>redirect_uri</code> del login debe ser EXACTAMENTE el de arriba (sin <code>?</code> ni <code>#</code>).</li>
                <li>Añádelo tal cual en la app de Twitch → <b>OAuth Redirect URLs</b>.</li>
              </ul>
            </div>

            <div class="muted small" style="margin-top:10px">
              Tip: si abres esto desde tu <code>control.html</code> en popup, cuando llegue el token
              se enviará por <code>postMessage</code> al panel automáticamente.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  const pill = document.getElementById("pill");
  const msgBox = document.getElementById("msgBox");

  const tokenBox = document.getElementById("tokenBox");
  const scopeBox = document.getElementById("scopeBox");

  const closeBtn = document.getElementById("closeBtn");
  const copyTokenBtn = document.getElementById("copyTokenBtn");
  const copyScopesBtn = document.getElementById("copyScopesBtn");

  const redirectBox = document.getElementById("redirectBox");
  const copyRedirectBtn = document.getElementById("copyRedirectBtn");

  const clientIdEl = document.getElementById("clientId");
  const scopesEl = document.getElementById("scopes");
  const openAuthBtn = document.getElementById("openAuthBtn");
  const copyAuthBtn = document.getElementById("copyAuthBtn");

  const broadcasterIdEl = document.getElementById("broadcasterId");
  const loginNameEl = document.getElementById("loginName");
  const clientIdOutEl = document.getElementById("clientIdOut");
  const expiresOutEl = document.getElementById("expiresOut");

  const copyBroadcasterBtn = document.getElementById("copyBroadcasterBtn");
  const copyLoginBtn = document.getElementById("copyLoginBtn");

  const okPill = (t) => { pill.className = "pill ok"; pill.textContent = t; };
  const badPill = (t) => { pill.className = "pill bad"; pill.textContent = t; };

  const showWarn = (html) => { msgBox.className = "warn small"; msgBox.innerHTML = html; };
  const showGood = (html) => { msgBox.className = "good small"; msgBox.innerHTML = html; };
  const clearMsg = () => { msgBox.className = ""; msgBox.innerHTML = ""; };

  function cleanRedirectUri() {
    // redirect_uri estable: sin query, sin hash
    return location.origin + location.pathname;
  }

  redirectBox.value = cleanRedirectUri();

  // Twitch devuelve token en fragment (#access_token=...)
  const hash = (location.hash || "").startsWith("#") ? location.hash.slice(1) : "";
  const hp = new URLSearchParams(hash);

  const accessToken = hp.get("access_token") || "";
  const scope = hp.get("scope") || "";
  const state = hp.get("state") || "";
  const tokenType = hp.get("token_type") || "bearer";

  // Errores pueden venir en query (?error=...)
  const qp = new URLSearchParams(location.search);
  const err = qp.get("error") || "";
  const errDesc = qp.get("error_description") || "";

  function safeDecode(s) {
    try { return decodeURIComponent(s || ""); } catch { return String(s || ""); }
  }

  async function copyText(text) {
    const t = String(text || "").trim();
    if (!t) return false;
    try { await navigator.clipboard.writeText(t); return true; }
    catch (_) {
      try {
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      } catch { return false; }
    }
  }

  function buildAuthorizeUrl(clientId, scopes) {
    const cid = String(clientId || "").trim();
    const sc = String(scopes || "").trim();
    const redirect = cleanRedirectUri();
    const st = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Math.random()).slice(2);

    try { sessionStorage.setItem("twitch_oauth_state", st); } catch (_) {}

    const u = new URL("https://id.twitch.tv/oauth2/authorize");
    u.searchParams.set("response_type", "token"); // implicit
    u.searchParams.set("client_id", cid);
    u.searchParams.set("redirect_uri", redirect);
    if (sc) u.searchParams.set("scope", sc);
    u.searchParams.set("state", st);
    u.searchParams.set("force_verify", "true");
    return u.toString();
  }

  function clearTokenFromAddressBar() {
    // quita el fragmento con el token de la barra (seguridad)
    try { history.replaceState(null, "", location.pathname + location.search); } catch (_) {}
  }

  function setValidatedInfo({ user_id = "", login = "", client_id = "", scopes = [], expires_in = 0 } = {}) {
    broadcasterIdEl.textContent = user_id ? String(user_id) : "(—)";
    loginNameEl.textContent = login ? String(login) : "(—)";
    clientIdOutEl.textContent = client_id ? String(client_id) : "(—)";

    if (expires_in && Number.isFinite(expires_in)) {
      const mins = Math.max(0, Math.round(expires_in / 60));
      expiresOutEl.textContent = `${mins} min`;
    } else {
      expiresOutEl.textContent = "(—)";
    }

    // Si validate trae scopes como array, mostramos esos
    if (Array.isArray(scopes) && scopes.length) {
      scopeBox.textContent = scopes.join(" ");
    }
  }

  async function validateToken(token) {
    const t = String(token || "").trim();
    if (!t) throw new Error("token vacío");

    // Intenta Bearer primero, y si falla, OAuth (por compat)
    const tryFetch = async (authValue) => {
      const r = await fetch("https://id.twitch.tv/oauth2/validate", {
        method: "GET",
        headers: { "Authorization": authValue }
      });
      if (!r.ok) {
        const txt = await r.text().catch(() => "");
        const e = new Error(`validate HTTP ${r.status}${txt ? ` — ${txt.slice(0, 180)}` : ""}`);
        e.status = r.status;
        throw e;
      }
      return await r.json();
    };

    try {
      return await tryFetch(`Bearer ${t}`);
    } catch (e) {
      // 401 suele ser auth header incorrecta o token inválido
      return await tryFetch(`OAuth ${t}`);
    }
  }

  // UI handlers
  copyRedirectBtn.addEventListener("click", async () => {
    const ok = await copyText(redirectBox.value);
    if (ok) showGood("✅ Redirect URI copiado.");
    else showWarn("❌ No se pudo copiar. Copia manualmente.");
  });

  copyTokenBtn.addEventListener("click", async () => {
    const ok = await copyText(tokenBox.textContent);
    if (ok) showGood("✅ Token copiado.");
    else showWarn("❌ No se pudo copiar. Copia manualmente.");
  });

  copyScopesBtn.addEventListener("click", async () => {
    const ok = await copyText(scopeBox.textContent);
    if (ok) showGood("✅ Scopes copiados.");
    else showWarn("❌ No se pudo copiar. Copia manualmente.");
  });

  copyBroadcasterBtn.addEventListener("click", async () => {
    const ok = await copyText(broadcasterIdEl.textContent);
    if (ok) showGood("✅ Broadcaster ID copiado.");
    else showWarn("❌ No se pudo copiar. Copia manualmente.");
  });

  copyLoginBtn.addEventListener("click", async () => {
    const ok = await copyText(loginNameEl.textContent);
    if (ok) showGood("✅ Login copiado.");
    else showWarn("❌ No se pudo copiar. Copia manualmente.");
  });

  closeBtn.addEventListener("click", () => {
    try { window.close(); } catch (_) {}
  });

  openAuthBtn.addEventListener("click", () => {
    clearMsg();
    const cid = clientIdEl.value.trim();
    if (!cid) { showWarn("Pon tu <b>Client ID</b> primero."); return; }
    const url = buildAuthorizeUrl(cid, scopesEl.value);
    location.href = url;
  });

  copyAuthBtn.addEventListener("click", async () => {
    clearMsg();
    const cid = clientIdEl.value.trim();
    if (!cid) { showWarn("Pon tu <b>Client ID</b> primero."); return; }
    const url = buildAuthorizeUrl(cid, scopesEl.value);
    const ok = await copyText(url);
    if (ok) showGood("✅ URL de login copiada.");
    else showWarn("❌ No se pudo copiar. Copia manualmente.");
  });

  // Estado principal
  (async () => {
    if (err) {
      badPill("Error OAuth");
      const desc = safeDecode(errDesc);
      tokenBox.textContent = "(vacío)";
      scopeBox.textContent = "(vacío)";
      showWarn(`<b>Error OAuth:</b> <code>${err}</code>${desc ? ` — ${desc}` : ""}<br/><br/>
        Si el error es <b>redirect_mismatch</b>, revisa que <b>redirect_uri</b> sea exactamente:<br/>
        <code>${cleanRedirectUri()}</code><br/>
        y que esté añadido en tu app → <b>OAuth Redirect URLs</b>.`);
      return;
    }

    if (!accessToken) {
      badPill("Sin token");
      tokenBox.textContent = "(vacío)";
      scopeBox.textContent = "(vacío)";
      showWarn(`No llegó <code>access_token</code>.<br/><br/>
        Asegúrate de que el login usa <code>response_type=token</code> y que el <code>redirect_uri</code> coincide exactamente con el registrado.`);
      return;
    }

    okPill("Token recibido ✅");
    tokenBox.textContent = accessToken;
    scopeBox.textContent = safeDecode(scope || "(sin scope)");
    clearMsg();
    showGood(`Token recibido (<code>${tokenType || "bearer"}</code>)${state ? ` · state=<code>${state}</code>` : ""}.<br/>Validando…`);

    // Guardado local básico
    try {
      localStorage.setItem("twitch_oauth_access_token", accessToken);
      localStorage.setItem("twitch_oauth_scope_raw", scope || "");
      localStorage.setItem("twitch_oauth_token_type", tokenType || "bearer");
      localStorage.setItem("twitch_oauth_saved_at", String(Date.now()));
    } catch (_) {}

    // VALIDATE -> saca broadcaster id + login + client_id
    let validated = null;
    try {
      validated = await validateToken(accessToken);
      setValidatedInfo(validated);

      // Guardado local enriquecido
      try {
        if (validated && typeof validated === "object") {
          localStorage.setItem("twitch_oauth_user_id", String(validated.user_id || ""));
          localStorage.setItem("twitch_oauth_login", String(validated.login || ""));
          localStorage.setItem("twitch_oauth_client_id", String(validated.client_id || ""));
          localStorage.setItem("twitch_oauth_scope", Array.isArray(validated.scopes) ? validated.scopes.join(" ") : "");
          localStorage.setItem("twitch_oauth_expires_in", String(validated.expires_in || ""));
        }
      } catch (_) {}

      showGood(
        `✅ Token validado.<br/>
         Broadcaster ID: <code>${String(validated.user_id || "")}</code><br/>
         Login: <code>${String(validated.login || "")}</code>`
      );
    } catch (e) {
      const msg = String(e?.message || e || "Error").slice(0, 220);
      showWarn(`Token recibido, pero <b>no se pudo validar</b>.<br/><code>${msg}</code><br/>
      Aun así puedes copiar el token y usarlo en tu panel.`);
    }

    // Devuelve al opener (tu control.html) si existe
    try {
      if (window.opener && window.opener !== window) {
        window.opener.postMessage({
          type: "TWITCH_OAUTH_TOKEN",
          access_token: accessToken,
          token_type: tokenType || "bearer",
          scope: (validated && Array.isArray(validated.scopes)) ? validated.scopes.join(" ") : safeDecode(scope || ""),
          state: state || "",
          // extras automáticos:
          broadcaster_id: validated?.user_id ? String(validated.user_id) : "",
          user_id: validated?.user_id ? String(validated.user_id) : "",
          login: validated?.login ? String(validated.login) : "",
          client_id: validated?.client_id ? String(validated.client_id) : ""
        }, location.origin);
      }
    } catch (_) {}

    // Limpia la URL para no dejar el token en el address bar
    clearTokenFromAddressBar();
  })();
})();
</script>
</body>
</html>
